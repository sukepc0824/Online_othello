<!DOCTYPE html>
<html>
<head>
  <title>Simple Othello with Baserow</title>
  <style>
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      grid-template-rows: repeat(8, 40px);
      gap: 2px;
    }
    .cell {
      width: 40px;
      height: 40px;
      background: green;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .black { background-color: black; border-radius: 50%; width: 30px; height: 30px; }
    .white { background-color: white; border-radius: 50%; width: 30px; height: 30px; }
  </style>
</head>
<body>
  <h2>Simple Othello</h2>
  <div id="turnInfo"></div>
  <div id="board"></div>

  <script>
    const API_URL = 'https://api.baserow.io/api/database/rows/table/1/';
    const API_TOKEN = 'Zah39yt4kGeZuHj79hrQMaxNdLkyDULI'; // BaserowのAPIトークン
    const GAME_ID = 1; // ゲームID（手動で設定）

    let currentBoard = [];
    let currentTurn = 'B';

    // ゲームデータを取得する
    async function fetchGame() {
      const res = await fetch(`${API_URL}${GAME_ID}/`, {
        headers: {
          'Authorization': `Token ${API_TOKEN}`
        }
      });
      const data = await res.json();
      currentBoard = JSON.parse(data.board);
      currentTurn = data.current_turn;
      renderBoard();
      document.getElementById('turnInfo').innerText = `Current turn: ${currentTurn === 'B' ? 'Black' : 'White'}`;
    }

    // ゲームデータを更新する
    async function updateGame() {
      await fetch(`${API_URL}${GAME_ID}/`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${API_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          board: JSON.stringify(currentBoard),
          current_turn: currentTurn === 'B' ? 'W' : 'B'
        })
      });
    }

    // ボードを描画
    function renderBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          const piece = currentBoard[i][j];
          if (piece === 'B') cell.innerHTML = '<div class="black"></div>';
          if (piece === 'W') cell.innerHTML = '<div class="white"></div>';
          cell.onclick = () => handleMove(i, j);
          board.appendChild(cell);
        }
      }
    }

    // ユーザーの移動を処理する
    function isValidMove(row, col) {
      return currentBoard[row][col] === '';
    }

    async function handleMove(row, col) {
      if (!isValidMove(row, col)) return;
      currentBoard[row][col] = currentTurn;
      await updateGame();
      await fetchGame(); // 再描画
    }

    // 初期ボード設定
    function initBoard() {
      const board = Array(8).fill(null).map(() => Array(8).fill(''));
      board[3][3] = 'W';
      board[3][4] = 'B';
      board[4][3] = 'B';
      board[4][4] = 'W';
      return board;
    }

    // 初回読み込み
    fetchGame();

    // 5秒ごとにゲーム状態を更新
    setInterval(fetchGame, 5000);
  </script>
</body>
</html>
