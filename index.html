<!DOCTYPE html>
<html>

<head>
  <title>Othello Game with Baserow</title>
  <style>
    #board {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      grid-template-rows: repeat(8, 40px);
      gap: 2px;
    }

    .cell {
      width: 40px;
      height: 40px;
      background: green;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .black,
    .white {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }

    .black {
      background: black;
    }

    .white {
      background: white;
    }
  </style>
</head>

<body>
  <h2>„Ç™„É≥„É©„Ç§„É≥„Ç™„Çª„É≠</h2>
  <button onclick="resetGame()">üîÑ „É™„Çª„ÉÉ„Éà</button>
  <div id="turnInfo"></div>
  <div id="board"></div>

  <script>
    const API_URL = 'https://api.baserow.io/api/database/rows/table/505424/';
    const API_TOKEN = 'Zah39yt4kGeZuHj79hrQMaxNdLkyDULI'; // ‚Üê „Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆAPI„Éà„Éº„ÇØ„É≥„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ
    const GAME_ID = 1;

    let currentBoard = [];
    let currentTurn = 'B';

    const directions = [
      [-1, 0], [1, 0], [0, -1], [0, 1],
      [-1, -1], [-1, 1], [1, -1], [1, 1]
    ];

    function insideBoard(x, y) {
      return x >= 0 && x < 8 && y >= 0 && y < 8;
    }

    function getOpponent(turn) {
      return turn === 'B' ? 'W' : 'B';
    }

    function getFlippableDiscs(board, x, y, player) {
      if (board[x][y] !== "") return [];

      const opponent = getOpponent(player);
      const flippable = [];

      for (let [dx, dy] of directions) {
        let nx = x + dx, ny = y + dy;
        const temp = [];

        while (insideBoard(nx, ny) && board[nx][ny] === opponent) {
          temp.push([nx, ny]);
          nx += dx;
          ny += dy;
        }

        if (insideBoard(nx, ny) && board[nx][ny] === player && temp.length > 0) {
          flippable.push(...temp);
        }
      }

      return flippable;
    }

    async function fetchGame() {
      const res = await fetch(`${API_URL}${GAME_ID}/?user_field_names=true`, {
        headers: { 'Authorization': `Token ${API_TOKEN}` }
      });
      const data = await res.json();
      currentBoard = JSON.parse(data.board);
      currentTurn = data.current_turn;
      renderBoard();
    }

    async function updateGame() {
      await fetch(`${API_URL}${GAME_ID}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${API_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          board: JSON.stringify(currentBoard),
          current_turn: getOpponent(currentTurn)
        })
      });
    }

    function renderBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      document.getElementById('turnInfo').innerText = `ÁèæÂú®„ÅÆ„Çø„Éº„É≥Ôºö${currentTurn === 'B' ? '‚óè' : '‚óã'}`;

      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if (currentBoard[i][j] === 'B') {
            const disc = document.createElement('div');
            disc.className = 'black';
            cell.appendChild(disc);
          } else if (currentBoard[i][j] === 'W') {
            const disc = document.createElement('div');
            disc.className = 'white';
            cell.appendChild(disc);
          }

          cell.onclick = () => handleClick(i, j);
          board.appendChild(cell);
        }
      }
    }

    async function handleClick(i, j) {
      const flips = getFlippableDiscs(currentBoard, i, j, currentTurn);
      if (flips.length === 0) return;

      currentBoard[i][j] = currentTurn;
      for (const [x, y] of flips) {
        currentBoard[x][y] = currentTurn;
      }

      await updateGame();
      await fetchGame();
    }

    function initBoardIfNeeded() {
      if (!currentBoard || currentBoard.length !== 8) {
        currentBoard = Array(8).fill(null).map(() => Array(8).fill(""));
        currentBoard[3][3] = 'W';
        currentBoard[3][4] = 'B';
        currentBoard[4][3] = 'B';
        currentBoard[4][4] = 'W';
      }
    }

    // ÂàùÊúüË™≠„ÅøËæº„Åø
    fetchGame();

    // ÂÆöÊúüÊõ¥Êñ∞
    setInterval(fetchGame, 2000);

    async function resetGame() {
      const newBoard = Array(8).fill(null).map(() => Array(8).fill(""));
      newBoard[3][3] = 'W';
      newBoard[3][4] = 'B';
      newBoard[4][3] = 'B';
      newBoard[4][4] = 'W';

      await fetch(`${API_URL}${GAME_ID}/?user_field_names=true`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Token ${API_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          board: JSON.stringify(newBoard),
          current_turn: "B"
        })
      });

      await fetchGame(); // Âç≥ÊôÇÂèçÊò†
    }

  </script>
</body>

</html>